name: Build and deploy Aseprite

on:
  schedule:
    - cron: '0 0 * * *'
  push:
    branches: [ 'master' ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  check-version:
    name: Check latest Aseprite release
    runs-on: ubuntu-latest
    outputs:
      download_url: ${{ steps.version_info.outputs.download_url }}
      latest_tag: ${{ steps.version_info.outputs.latest_tag }}
      should_build: ${{ steps.should_build.outputs.should_build }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Get latest version info
        id: version_info
        run: |
          data=$(curl -sL https://api.github.com/repos/aseprite/aseprite/releases/latest)
          LATEST_TAG=$(echo "${data}" | jq -r '.tag_name')
          DOWNLOAD_URL=$(echo "${data}" | jq -r '.assets[].browser_download_url | select(contains("source"))')
          VERSION_INFO=$(echo "${data}" | jq -r '.body')
          
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "version_info<<EOF" >> $GITHUB_OUTPUT
          echo "$VERSION_INFO" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check if should build
        id: should_build
        run: |
          # 简化版本检查逻辑
          echo "Building new version: ${{ steps.version_info.outputs.latest_tag }}"
          echo "should_build=true" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        if: steps.should_build.outputs.should_build == 'true'
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version_info.outputs.latest_tag }}
          name: Aseprite ${{ steps.version_info.outputs.latest_tag }}
          body: ${{ steps.version_info.outputs.version_info }}
          draft: true
          prerelease: false

  build-aseprite:
    name: Build Aseprite
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
        include:
          - os: windows-latest
            shell: cmd
          - os: ubuntu-latest  
            shell: bash
          - os: macos-latest
            shell: bash
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Skia dependencies
        id: cache-skia
        uses: actions/cache@v4
        with:
          path: skia
          key: skia-${{ matrix.os }}-m81-b607b32047

      - name: Download Skia
        if: steps.cache-skia.outputs.cache-hit != 'true'
        run: |
          curl -o skia.zip -L "https://github.com/aseprite/skia/releases/download/m81-b607b32047/Skia-${{ matrix.os == 'macos-latest' && 'mac' || matrix.os == 'windows-latest' && 'win' || 'linux' }}-Release-x64.zip"
          unzip skia.zip -d skia

      - name: Download Aseprite source
        run: |
          curl -o aseprite-source.zip -L "${{ needs.check-version.outputs.download_url }}"
          unzip aseprite-source.zip -d aseprite
          mkdir -p aseprite/build

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        uses: seanmiddleditch/gha-setup-ninja@v3

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libxcursor-dev libxi-dev libgl1-mesa-dev libfontconfig1-dev

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew update
          brew install ninja p7zip

      - name: Setup MSVC (Windows)
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake
        working-directory: aseprite/build
        run: |
          # Windows specific CMake configuration
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cmake -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ^
                  -DLAF_BACKEND=skia ^
                  -DSKIA_DIR=../../skia ^
                  -DSKIA_LIBRARY_DIR=../../skia/out/Release-x64 ^
                  -G Ninja ..
          # Linux specific CMake configuration  
          elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            cmake -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
                  -DLAF_BACKEND=skia \
                  -DSKIA_DIR=../../skia \
                  -DSKIA_LIBRARY_DIR=../../skia/out/Release-x64 \
                  -G Ninja ..
          # macOS specific CMake configuration
          else
            cmake -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
                  -DCMAKE_OSX_ARCHITECTURES=x86_64 \
                  -DCMAKE_OSX_DEPLOYMENT_TARGET=10.9 \
                  -DLAF_BACKEND=skia \
                  -DSKIA_DIR=../../skia \
                  -DSKIA_LIBRARY_DIR=../../skia/out/Release-x64 \
                  -G Ninja ..
          fi
        shell: ${{ matrix.shell }}

      - name: Build with Ninja
        working-directory: aseprite/build
        run: ninja aseprite

      - name: Clean build artifacts
        working-directory: aseprite/build/bin
        run: |
          # Remove unnecessary build artifacts
          find . -name "gen*" -delete
          find . -name "modp_b64_gen*" -delete
        shell: bash

      - name: Create portable config (Windows)
        if: matrix.os == 'windows-latest'
        working-directory: aseprite/build/bin
        run: |
          echo # This file is here so Aseprite behaves as a portable program > aseprite.ini

      - name: Install 7zip (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get install -y p7zip-full

      - name: Package artifact
        working-directory: aseprite/build/bin
        run: |
          # Determine platform name for the zip file
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            PLATFORM="Windows"
            7z a -tzip "Aseprite-${{ needs.check-version.outputs.latest_tag }}-$PLATFORM.zip" *
          elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            PLATFORM="Linux"
            7z a -tzip "Aseprite-${{ needs.check-version.outputs.latest_tag }}-$PLATFORM.zip" *
          else
            PLATFORM="macOS"
            7z a -tzip "Aseprite-${{ needs.check-version.outputs.latest_tag }}-$PLATFORM.zip" *
          fi
        shell: bash

      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          files: aseprite/build/bin/Aseprite-${{ needs.check-version.outputs.latest_tag }}-*.zip
          draft: false